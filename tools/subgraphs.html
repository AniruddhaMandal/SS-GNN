<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Multiple 3D Graphs</title>
  <style>
    html,body{ height:100%; margin:0; display:flex; }
    /* controls */
    #controls { width: 260px; padding:8px; background:#f5f5f5; overflow:auto; box-shadow: 2px 0 6px rgba(0,0,0,0.08); transition: width 260ms ease; }
    #controls.collapsed { width: 44px; padding-left:6px; padding-right:6px; } /* collapsed narrow sidebar */
    /* hide long text when collapsed */
    #controls.collapsed h3,
    #controls.collapsed p,
    #controls.collapsed hr,
    #controls.collapsed label[for="toggle-all"] { display:none; }

    #3d-graph { flex:1; height:100vh; }

    .graph-toggle { margin:6px 0; }

    /* collapse button */
    #collapse-btn {
      position: absolute;
      left: calc(260px - 18px); /* initially aligned at controls right edge */
      top: 8px;
      width: 36px;
      height: 36px;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,0.08);
      background: white;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: left 260ms ease, transform 260ms ease;
    }
    #collapse-btn.collapsed { left: calc(44px - 18px); transform: rotate(180deg); }

    /* keep checkboxes usable in collapsed mode (they'll be narrow) */
    #controls.collapsed #checkboxes { padding-top:6px; }
  </style>
</head>
<body>
  <div id="controls">
    <h3>Graphs</h3>
    <div id="checkboxes">Loading…</div>
    <hr/>
    <label><input id="toggle-all" type="checkbox" checked> Show all</label>
    <p style="font-size:12px;color:#444">Drag nodes to untangle. Right-click to unpin nodes.</p>
  </div>

  <!-- minimal collapse button -->
  <button id="collapse-btn" title="Collapse / Expand sidebar">«</button>

  <div id="3d-graph"></div>

  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="https://unpkg.com/3d-force-graph"></script>

  <script>
    fetch('graph_json_data/multi_graphs.json').then(r => r.json()).then(data => {
      // Determine distinct graph_ids
      const graphIds = Array.from(new Set(data.nodes.map(n=>n.graph_id))).sort((a,b)=>a-b);

      // attach checkboxes
      const cbDiv = document.getElementById('checkboxes');
      cbDiv.innerHTML = "";
      graphIds.forEach(id => {
        const wrapper = document.createElement('div');
        wrapper.className = 'graph-toggle';
        wrapper.innerHTML = `<label><input type="checkbox" class="gcb" data-g="${id}" checked> Graph ${id}</label>`;
        cbDiv.appendChild(wrapper);
      });

      document.getElementById('toggle-all').addEventListener('change', e => {
        const checked = e.target.checked;
        document.querySelectorAll('.gcb').forEach(cb => cb.checked = checked);
        applyFilter();
      });

      document.querySelectorAll('.gcb').forEach(cb => cb.addEventListener('change', applyFilter));

      // Build initial graph
      // expose the Graph instance on window so collapse handler can call zoomToFit()
      window.Graph = ForceGraph3D()(document.getElementById('3d-graph'))
        .graphData(data)
        .nodeAutoColorBy(null) // we'll use nodeColor accessor
        .nodeColor(node => node.color || null)
        .nodeLabel(node => node.label ? node.label : `id: ${node.orig_id} (g${node.graph_id})`)
        .nodeRelSize(4)
        .linkOpacity(0.6)
        .linkWidth(l => l.weight ? Math.max(0.5, Math.log(1 + l.weight)) : 1)
        .d3VelocityDecay(0.35)
        .d3AlphaDecay(0.02)
        .enableNodeDrag(true)
        .onNodeDragEnd(node => {
          // pin node where dropped
          node.fx = node.x;
          node.fy = node.y;
          node.fz = node.z;
        });

      // Provide a utility to filter nodes/links by selected graph_ids
      function applyFilter() {
        const checked = Array.from(document.querySelectorAll('.gcb'))
          .filter(cb => cb.checked).map(cb => parseInt(cb.dataset.g));
        // filter nodes and links
        const filteredNodes = data.nodes.filter(n => checked.includes(n.graph_id));
        const nodeIds = new Set(filteredNodes.map(n => n.id));
        const filteredLinks = data.links.filter(l => nodeIds.has(l.source) && nodeIds.has(l.target));
        Graph.graphData({nodes: filteredNodes, links: filteredLinks});
      }

      // Right-click to unpin all nodes
      window.addEventListener('contextmenu', e => {
        e.preventDefault();
        Graph.graphData().nodes.forEach(n => {
          delete n.fx; delete n.fy; delete n.fz;
        });
      });

      // initial centering & zoom
      Graph.zoomToFit(400, 50);
    }).catch(err => {
      document.body.innerHTML = "<pre style='color:red'>Failed to load multi_graphs.json. Run a local HTTP server (python -m http.server) and ensure the JSON file is present.</pre>";
      console.error(err);
    });


    /* ---------- Minimal collapse/expand handler ---------- */
    (function(){
      const controls = document.getElementById('controls');
      const btn = document.getElementById('collapse-btn');
      let collapsed = false;

      btn.addEventListener('click', () => {
        collapsed = !collapsed;
        if(collapsed){
          controls.classList.add('collapsed');
          btn.classList.add('collapsed');
          btn.textContent = '»';
        } else {
          controls.classList.remove('collapsed');
          btn.classList.remove('collapsed');
          btn.textContent = '«';
        }

        // after the CSS transition, notify renderer and zoom to fit
        setTimeout(() => {
          // trigger a browser resize event so three.js can adapt
          window.dispatchEvent(new Event('resize'));
          // try to re-fit the graph
          if (window.Graph && typeof window.Graph.zoomToFit === 'function') {
            try { window.Graph.zoomToFit(400, 50); } catch (e) { /* ignore */ }
          }
        }, 300);
      });

      // adjust initial button position if window is small
      window.addEventListener('resize', () => {
        // no-op here, but leaving hook if you want to adapt button position
      });
    })();
  </script>
</body>
</html>
